#!/bin/bash
ANKI_PROFILE="${ANKI_PROFILE:-$(ls -1 "${XDG_DATA_HOME:-$HOME/.local/share}/Anki2" 2>/dev/null | grep -v '^addons' | head -1)}"
MEDIA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/Anki2/$ANKI_PROFILE/collection.media"
BACKUP_DIR="${ANKI_SNAPSHOT_DIR:-$HOME/anki-snapshot}"
RANGE="${1:-HEAD~1..HEAD}"
cd "$BACKUP_DIR"

RED='\033[0;31m'; GREEN='\033[0;32m'; CYAN='\033[0;36m'; YELLOW='\033[0;33m'; BOLD='\033[1m'; DIM='\033[2m'; RESET='\033[0m'

echo -e "${BOLD}‚îÅ‚îÅ‚îÅ Anki Changes: $RANGE ‚îÅ‚îÅ‚îÅ${RESET}"

git diff "$RANGE" -- notes.txt | while IFS= read -r line; do
    # Skip diff headers
    [[ "$line" =~ ^(diff|index|---|\+\+\+|@@) ]] && [[ "$line" =~ ^@@ ]] && echo -e "\n${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}" && continue
    [[ "$line" =~ ^(diff|index|---|\+\+\+) ]] && continue
    
    # Process added/removed lines
    if [[ "$line" =~ ^\+ ]]; then
        content="${line:1}"
        # Extract note ID (first field)
        note_id="${content%%|*}"
        # Get fields (skip id and model_id)
        fields=$(echo "$content" | cut -d'|' -f3-)
        # Shorten image refs
        fields=$(echo "$fields" | sed 's/\[IMG:\([^]]*\)\]/[üñº \1]/g')
        # Truncate if too long
        [[ ${#fields} -gt 150 ]] && fields="${fields:0:150}..."
        echo -e "${GREEN}+ [${note_id}] ${fields}${RESET}"
    elif [[ "$line" =~ ^- ]]; then
        content="${line:1}"
        note_id="${content%%|*}"
        fields=$(echo "$content" | cut -d'|' -f3-)
        fields=$(echo "$fields" | sed 's/\[IMG:\([^]]*\)\]/[üñº \1]/g')
        [[ ${#fields} -gt 150 ]] && fields="${fields:0:150}..."
        echo -e "${RED}‚àí [${note_id}] ${fields}${RESET}"
    fi
done

# Image changes
echo -e "\n${YELLOW}‚îÅ‚îÅ‚îÅ Image Changes ‚îÅ‚îÅ‚îÅ${RESET}"
PLAIN_DIFF=$(git diff "$RANGE" -- notes.txt)
REMOVED=$(echo "$PLAIN_DIFF" | grep '^-' | grep -v '^---' | grep -oE '\[IMG:[^\]]+\]' | sed 's/\[IMG://g;s/\]//g' | sort -u)
ADDED=$(echo "$PLAIN_DIFF" | grep '^+' | grep -v '^+++' | grep -oE '\[IMG:[^\]]+\]' | sed 's/\[IMG://g;s/\]//g' | sort -u)
NEW_ONLY=$(comm -13 <(echo "$REMOVED" | sort) <(echo "$ADDED" | sort) 2>/dev/null | grep -v '^$')
DEL_ONLY=$(comm -23 <(echo "$REMOVED" | sort) <(echo "$ADDED" | sort) 2>/dev/null | grep -v '^$')

[[ -n "$NEW_ONLY" ]] && echo -e "${GREEN}Added:${RESET}" && echo "$NEW_ONLY" | while read -r img; do
    [[ -z "$img" ]] && continue
    echo -e "  ${GREEN}+ $img${RESET}"
    echo -e "    \033]8;;file://$MEDIA_DIR/$img\afile://$MEDIA_DIR/$img\033]8;;\a"
done
[[ -n "$DEL_ONLY" ]] && echo -e "${RED}Removed:${RESET}" && echo "$DEL_ONLY" | while read -r img; do
    [[ -z "$img" ]] && continue
    echo -e "  ${RED}‚àí $img${RESET}"
done
[[ -z "$NEW_ONLY" && -z "$DEL_ONLY" ]] && echo -e "${DIM}  No image changes${RESET}"
echo ""
