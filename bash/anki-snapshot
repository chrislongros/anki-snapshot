#!/bin/bash
set -e
ANKI_PROFILE="${ANKI_PROFILE:-$(ls -1 "${XDG_DATA_HOME:-$HOME/.local/share}/Anki2" 2>/dev/null | grep -v '^addons' | head -1)}"
ANKI_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/Anki2/$ANKI_PROFILE"
BACKUP_DIR="${ANKI_SNAPSHOT_DIR:-$HOME/anki-snapshot}"
TMP_DB="/tmp/anki-snapshot-$$.anki2"

[[ ! -d "$ANKI_DIR" ]] && echo "‚ùå Anki profile not found: $ANKI_DIR" && exit 1
pgrep -x anki >/dev/null && echo "‚ö†Ô∏è  Close Anki first!" && exit 1
pgrep -f aqt >/dev/null && echo "‚ö†Ô∏è  Close Anki first!" && exit 1

mkdir -p "$BACKUP_DIR" && cd "$BACKUP_DIR"
[[ ! -d .git ]] && git init

echo "üì¶ Copying database to temp..."
cp "$ANKI_DIR/collection.anki2" "$TMP_DB"
trap "rm -f '$TMP_DB'" EXIT

echo "üìÑ Exporting notes for diff..."
sqlite3 "$TMP_DB" "SELECT n.id, n.mid, replace(n.flds, char(31), ' | '), n.tags FROM notes n ORDER BY n.id;" | sed "
    s|<img[^>]*src=\"\([^\"]*\)\"[^>]*>|[IMG:\1]|g
    s|\[sound:\([^]]*\)]|[SND:\1]|g
    s/<[^>]*>//g
    s/&nbsp;/ /g
    s/&lt;/</g
    s/&gt;/>/g
    s/&amp;/\&/g
" > "$BACKUP_DIR/notes.txt"

echo "üìù Committing..."
git add notes.txt
git commit -m "Snapshot $(date '+%Y-%m-%d %H:%M')" || echo "No changes"
echo "‚úÖ Done!" && git log --oneline -3
